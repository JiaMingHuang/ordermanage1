<div class="panel panel-default">
    <div class="panel-heading">修改库存商品</div>
    <div class="panel-body">

        <div class="page-header part_header">
            <h1 style="margin-top: 10px">
                <small>订单详情</small>
            </h1>
        </div>
        <div class="panel-body">
            <table width="100%"
                   class="table table-striped table-bordered table-hover" id="order-list">
                <thead>
                <tr>
                    <th>品名规格颜色</th>
                    <th>件数</th>
                    <th>装箱数</th>
                    <th>总数量</th>
                    <th>单位</th>
                    <th>单价</th>
                    <th>总金额</th>
                    <th>工厂</th>
                    <th>实际收货数量</th>
                    <th>收货数量</th>
                    <th>工厂未交件数</th>
                    <th>工厂未交数量</th>
                </tr>
                <tr hidden>
                    <th>name_spec_color</th>
                    <th>amount</th>
                    <th>packagenumber</th>
                    <th>totalnumber</th>
                    <th>unit</th>
                    <th>price</th>
                    <th>total</th>
                    <th>factoryid</th>
                    <th>actual_take_amount</th>
                    <th>storehouse_actual_take_totalnumber</th>
                    <th>factory_not_delivery_amount</th>
                    <th>factory_not_delivery_totalnumber</th>
                </tr>
                </thead>
                <tbody id="tbody-order-list">
                <tr th:each="orderdetail : ${orderdetails}">
                    <td th:text="${orderdetail.id}" hidden></td>
                    <td th:text="${orderdetail.orderid}" hidden></td>
                    <td th:text="${orderdetail.name_spec_color}"></td>
                    <td class="amount" th:text="${orderdetail.amount}"></td>
                    <td th:text="${orderdetail.packagenumber}"></td>
                    <td th:text="${orderdetail.totalnumber}"></td>
                    <td th:text="${orderdetail.unit}"></td>
                    <td th:text="${orderdetail.price}"></td>
                    <td th:text="${orderdetail.total}"></td>
                    <td th:text="${orderdetail.factorychinesename}"></td>
                    <td class="aaa"><input class="form-control ata" name="actual_take_amount" style="width: 90px"></td>
                    <td th:text="${orderdetail.amount}" hidden></td>
                    <td th:text="${orderdetail.storehouse_actual_take_totalnumber}"></td>
                    <td th:text="${orderdetail.factory_not_delivery_amount}"></td>
                    <td th:text="${orderdetail.factory_not_delivery_totalnumber}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <form id="order-alert-form" style="padding-left: 15px">
            <input id="id" name="id" th:value="${order.id}" type="hidden">
            <div class="form-group">
                <label>订单类型：</label>
                <span name="ordertype" th:text="${order.ordertype}" id="ordertype"></span>
            </div>
            <div class="form-group">
                <label>订单编号：</label>
                <span name="ordernumber" th:text="${order.ordernumber}" id="ordernumber"></span>
            </div>
            <div class="form-group">
                <label>客户名称：</label>
                <span name="clientname" th:text="${order.clientname}" id="clientname"></span>
            </div>
            <div class="form-group">
                <label>客户联系电话：</label>
                <span name="contact" th:text="${order.contact}" id="contact"></span>
            </div>
            <div class="form-group">
                <label>客户要求发货时间：</label>
                <span name="clientdeliverytime" th:text="${order.clientdeliverytime}"
                      id="clientdeliverytime"></span>
            </div>
            <div class="form-group">
                <label>工厂交货时间：</label>
                <span name="factorydeliverytime" th:text="${order.factorydeliverytime}"
                      id="factorydeliverytime"></span>
            </div>
            <div class="form-group">
                <label>送货地址：</label>
                <span name="address" th:text="${order.address}" id="address"></span>
            </div>
            <div class="form-group">
                <label>退货重镀原因：</label>
                <span name="reason" th:text="${order.reason}" id="reason"></span>
            </div>
            <div class="form-group">
                <label>订单创建时间：</label>
                <span name="createdate" th:text="${order.createdate}" id="createdate"></span>
            </div>
            <div class="form-group">
                <label>订单更新时间：</label>
                <span name="updatedate" th:text="${order.updatedate}" id="updatedate"></span>
            </div>
        </form>
    </div>
    <div class="panel-footer">
        <button type="button" class="btn btn-primary" onclick="updateOrder()">保存</button>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        var ordertype = $("#ordertype").text();
        if (ordertype == 1) {
            $("#ordertype").text("工厂订单")
        } else if (ordertype == 2) {
            $("#ordertype").text("电镀厂订单");
        }
    });

    $(".aaa input").keyup(function (){
        var actual = Number($(this).val());
        var amount = Number($(this).parent().parent().find("td").eq(11).html());
        var factorynotdeliver = Number($(this).parent().parent().find("td").eq(13).html());
        if ("" == factorynotdeliver) {
            if (actual > amount) {
                alert("实际收货数量不能大于该订单商品数量！");
                $(this).val("").focus();
                $(this).parent().parent().find("td").eq(3).text(amount);
            }
        } else {
            if (actual > factorynotdeliver) {
                alert("实际收货数量不能大于工厂未交件数！");
                $(this).val("").focus();
                $(this).parent().parent().find("td").eq(3).text(amount);
            }
        }

    });

    function updateOrder(){
        var orderVO = new Object();
        orderVO = {
            id : $("#order-alert-form").find("#id").val()
        };

        var orderDetailVOList=[];
        var trArr = $("#tbody-order-list").find("tr");
        trArr.each(function () {
            var orderDetail = new Object();
            var tdArr = $(this).children();
            orderDetail = {
                id : tdArr.eq(0).html(),
                orderid : tdArr.eq(1).html(),
                actual_take_amount: tdArr.eq(10).find("input").val()
            };
            orderDetailVOList.push(orderDetail);
        });

        console.log(orderVO);
        console.log(orderDetailVOList);
        var orderModel = {
            orderVO :orderVO,
            orderDetailVOList : orderDetailVOList
        };
        $.ajax({
            type: "POST",
            url: "/order/updateOrder",
            data: JSON.stringify(orderModel),
            dataType: "json",
            async: false,
            contentType:"application/json",
            context: document.body,
            success: function (data) {
                //alert(data);
                $("#myModal").click();
                initData();
            },
            error: function (data) {
                // 提示新增失败
            }
        });
    }

    $('.ata').bind('input propertychange change', function () {
        var temp02;
        if ("" == $(this).val() || null == $(this).val()) {
            temp02 = 0;
        } else {
            temp02 = parseInt($(this).val());
        }
        var temp01 = parseInt($(this).parent().parent().find("td").eq(11).html());
        $(this).parent().parent().find("td").eq(3).text(temp01 - temp02);
    });
</script>